services:
  loracat:
    build:
      context: .
      dockerfile: Dockerfile
    image: loracat:latest
    container_name: loracat

    # GPU passthrough
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

    # 128GB unified memory on DGX Spark — allocate generous shared memory
    shm_size: "64g"

    volumes:
      # Training dataset (images + captions)
      - ./dataset:/dataset
      # LoRA output
      - ./output:/output
      # Base SDXL model
      - ./models:/models
      # ComfyUI workflow (exported API JSON)
      - ./workflow_api.json:/app/workflow_api.json:ro
      # Face reference image (for image loader node injection)
      - ./face_reference.png:/app/face_reference.png:ro
      # Config (training config + workflow node mapping)
      - ./config:/app/config:ro
      # Prompts file (optional — only needed for per-batch mode)
      # Comment out if using full-workflow mode with baked-in prompts
      # - ./prompts.json:/app/prompts.json:ro

    environment:
      - COMFYUI_ENDPOINT=${COMFYUI_ENDPOINT:-http://host.docker.internal:8188}
      - COMFYUI_WORKFLOW=/app/workflow_api.json
      - WORKFLOW_CONFIG=/app/config/workflow_config.json
      - FACE_REFERENCE=/app/face_reference.png
      # PROMPTS_FILE only needed for per-batch mode (uncomment if using prompts.json)
      # - PROMPTS_FILE=/app/prompts.json
      - GLOBAL_SEED=${GLOBAL_SEED:-}
      - DATASET_DIR=/dataset/images
      - OUTPUT_DIR=/output/lora
      - MODEL_PATH=/models/stable-diffusion-xl-base-1.0
      - TRAINING_CONFIG=/app/config/training_config.toml
      - TRIGGER_WORD=${TRIGGER_WORD:-nyafyi_woman}
      # Training hyperparameters
      - TRAIN_BATCH_SIZE=${TRAIN_BATCH_SIZE:-4}
      - GRADIENT_ACCUMULATION_STEPS=${GRADIENT_ACCUMULATION_STEPS:-1}
      - LEARNING_RATE=${LEARNING_RATE:-1e-4}
      - NUM_TRAIN_EPOCHS=${NUM_TRAIN_EPOCHS:-20}
      - LORA_RANK=${LORA_RANK:-32}
      - RESOLUTION=${RESOLUTION:-1024}
      - CAPTION_BATCH_SIZE=${CAPTION_BATCH_SIZE:-8}
      - COMFYUI_DELAY=${COMFYUI_DELAY:-2.0}
      - MIXED_PRECISION=${MIXED_PRECISION:-bf16}
      - DATALOADER_NUM_WORKERS=${DATALOADER_NUM_WORKERS:-4}
      # Optional: W&B logging
      - WANDB_API_KEY=${WANDB_API_KEY:-}
      - WANDB_PROJECT=${WANDB_PROJECT:-loracat}
      # NVIDIA container toolkit
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility

    # Allow access to host network for ComfyUI
    extra_hosts:
      - "host.docker.internal:host-gateway"

    # Pipeline steps to run (default: all)
    # Override with: docker compose run loracat --collect --caption --train
    # Or run individual steps: docker compose run loracat --caption --train
